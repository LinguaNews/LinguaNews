@page
@model LinguaNews.Pages.ParkWhiz.IndexModel
@{
    ViewData["Title"] = "ParkWhiz Map";
}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-o3Iu6wYk6s9Qf4mJv71Cwz3C1r6yq4b1m8q3g1x2+FQ=" crossorigin=""/>

<h2>@ViewData["Title"]</h2>

<div class="row">
    <div class="col-md-4">
        <form id="searchForm">
            <div class="mb-2">
                <label>Latitude</label>
                <input id="lat" class="form-control" value="40.7128" />
            </div>
            <div class="mb-2">
                <label>Longitude</label>
                <input id="lng" class="form-control" value="-74.0060" />
            </div>
            <div class="mb-2">
                <label>Radius (meters)</label>
                <input id="radius" class="form-control" value="1000" />
            </div>
            <div class="mb-2">
                <label>Query (optional)</label>
                <input id="q" class="form-control" />
            </div>
            <button type="submit" class="btn btn-primary">Search</button>
        </form>

        <ul id="results" class="list-group mt-3"></ul>
    </div>

    <div class="col-md-8">
        <div id="map" style="height:600px;"></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-p6m0xJYwq7q3vQ4D5N0tKq3Z4+2kHj6f1b9a6Y5m2vM=" crossorigin=""></script>

<script>
    (function () {
        const map = L.map('map').setView([40.7128, -74.0060], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const markers = L.layerGroup().addTo(map);

        function renderResults(list) {
            markers.clearLayers();
            const resultsEl = document.getElementById('results');
            resultsEl.innerHTML = '';
            list.forEach(item => {
                const lat = item.latitude || item.Latitude || item.Lat || 0;
                const lng = item.longitude || item.Longitude || item.Lng || 0;
                const name = item.name || 'Untitled';
                const address = item.address || '';

                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = name + (address ? (' — ' + address) : '');
                resultsEl.appendChild(li);

                if (lat && lng) {
                    const marker = L.marker([lat, lng]).bindPopup(`<strong>${name}</strong><br/>${address}`);
                    markers.addLayer(marker);
                }
            });

            if (list.length) {
                const first = list[0];
                if (first.latitude && first.longitude) {
                    map.setView([first.latitude, first.longitude], 14);
                }
            }
        }

        async function search(ev) {
            if (ev) ev.preventDefault();
            const lat = document.getElementById('lat').value;
            const lng = document.getElementById('lng').value;
            const radius = document.getElementById('radius').value;
            const q = document.getElementById('q').value;
            const url = `/api/parkwhiz/search?lat=${encodeURIComponent(lat)}&lng=${encodeURIComponent(lng)}&radius=${encodeURIComponent(radius)}&q=${encodeURIComponent(q)}`;
            const res = await fetch(url);
            if (!res.ok) {
                alert('Search failed: ' + res.status);
                return;
            }
            const data = await res.json();
            renderResults(data);
        }

        document.getElementById('searchForm').addEventListener('submit', search);

        // initial search
        search();
    })();
</script>